---
title: 'Wnioskowanie Statystyczne - projekt'
author: 'Mikołaj Gilewicz, Łukasz Kwiatkowski'
output:
  pdf_document: default
  html_document: default
---

# Wstęp

## Import bibliotek i danych

```{r, warning=F, message=F}
library(ggplot2)
library(gridExtra)

diamonds <- read.csv('diamonds.csv', colClasses=c(X='NULL'))
```

W naszym projekcie wykorzystamy zbiór danych zawierający parametry niemal 54 tysięcy diamentów pochodzących z katalogu "Tifanny & Co." z 2017 roku.

## Opis zmiennych

+-----------------+-------------------------------------------------------+
| zmienna         | opis                                                  |
+:================+=======================================================+
| `carat`         | waga diamentu (w karatach)                            |
+-----------------+-------------------------------------------------------+
| `cut`           | jakość szlifu diamentu (zmienna kategoryczna)         |
+-----------------+-------------------------------------------------------+
| `color`         | klasa koloru diamentu (zmienna kategoryczna)          |
+-----------------+-------------------------------------------------------+
| `clarity`       | poziom przejrzystości diamentu (zmienna kategoryczna) |
+-----------------+-------------------------------------------------------+
| `depth`         | proporcja wysokości diamentu do jego obwodu (w %)     |
+-----------------+-------------------------------------------------------+
| `table`         | maksymalna szerokość górnej części diamentu (w mm)    |
+-----------------+-------------------------------------------------------+
| `price`         | cena katalogowa diamentu podana w USD                 |
+-----------------+-------------------------------------------------------+
| `x`             | długość diamentu (w mm)                               |
+-----------------+-------------------------------------------------------+
| `y`             | szerokość diamentu (w mm)                             |
+-----------------+-------------------------------------------------------+
| `z`             | wysokość diamentu (w mm)                              |
+-----------------+-------------------------------------------------------+

## Wstępne przekształcenia zmiennych

Dostrzegliśmy, że niektóre diamenty nie mają podanych niektórych wymiarów (podana jest wartość 0 mm), dlatego będziemy musieli pozbyć się ich ze zbioru danych.

```{r}
diamonds$x[diamonds$x == 0] = NA
diamonds$y[diamonds$y == 0] = NA
diamonds$z[diamonds$z == 0] = NA
```

Faktoryzujemy zmienne kategoryczne, a ich wartości ustawiamy w kolejności od "najlepszej" do "najgorszej", co ułatwi potem odczytywanie wykresów.

```{r}
diamonds$cut <- factor(diamonds$cut, c('Ideal', 'Premium', 'Very Good', 'Good', 'Fair'))
diamonds$color <- factor(diamonds$color, c('D', 'E', 'F', 'G', 'H', 'I', 'J'))
diamonds$clarity <- factor(diamonds$clarity, c('IF', 'VVS1', 'VVS2', 'VS1', 'VS2', 'SI1', 'SI2', 'I1'))
```

*Uwaga:* Zmienna \`color\` określa jakość koloru danego diamentu. Nie chodzi więc tutaj o odcień czy barwę, a sklasyfikowanie koloru za pomocą używanej powszechnie skali od "D" (kolor najlepszy) do "Z" (kolor najgorszy). W naszych danych najgorszą występującą klasą jest "J".

Z tak przekształconego zbioru danych usuwamy wszystkie wiersze z wartościami `NA`.

```{r}
nrow(diamonds)
diamonds <- na.omit(diamonds)
nrow(diamonds)
```

Z naszego zbioru, w którym znajdowało się początkowo 53 940 diamentów, usunęliśmy 20, które nie zawierały pewnych parametrów. Stąd naszą analizę przeprowadzimy na pozostałych 53 920 diamentach.

# Analiza eksploracyjna

## Zależności między wymiarami diamentu

Intuicja podpowiada, że wymiary diamentu powinny być ze sobą w jakiś sposób skorelowane. Tezę tę zdaje się potwierdzać macierz korelacji zmiennych `x`, `y`, `z`.

```{r}
cor(diamonds[c(8:10)])
```

Zbudujemy jeszcze modele badające zależności między tymi zmiennymi.

```{r}
model_0.xy <- lm(x ~ y, diamonds)
summary(model_0.xy)
plot_1.xy <- ggplot(diamonds, aes(x, y)) +
              geom_point() +
              geom_smooth(method='lm', formula='y~x') +
              labs(title='Wykresy zależności między wymiarami diamentów')

model_0.xz <- lm(x ~ z, diamonds)
summary(model_0.xz)
plot_1.xz <- ggplot(diamonds, aes(x, z)) +
              geom_point() +
              geom_smooth(method='lm', formula='y~x')

model_0.yz <- lm(y ~ z, diamonds)
summary(model_0.yz)
plot_1.yz <- ggplot(diamonds, aes(y, z)) +
              geom_point() +
              geom_smooth(method='lm', formula='y~x')

grid.arrange(plot_1.xy, plot_1.xz, plot_1.yz, nrow=3)
```

Wszystkie trzy wymiary diamentu są od siebie liniowo zależne. Modele mają istotność statystyczną, a i wariancja jest nimi objaśniana w znacznej części. Na wykresach obserwacje (poza pojedynczymi wyjątkami) układają się wzdłuż linii regresji.

Celem ułatwienia dalszej analizy stworzymy zmienną `volume`, czyli objętość najmniejszego prostopadłościanu, w jakim zmieściłby się dany diament. Zmienną `volume` będziemy dalej nazywać "rozmiarem" diamentu.

```{r}
diamonds$volume = diamonds$x * diamonds$y * diamonds$z
```

## Zależność wagi od rozmiaru

Kolejną zależnością, która wydaje się dość oczywista jest wpływ rozmiaru diamentu na liczbę karatów.

```{r, message=F}
ggplot(diamonds, aes(volume, carat)) +
  geom_point() +
  geom_smooth(method='lm') +
  labs(title='Wykres zależności wagi diamentu od jego rozmiaru') +
  xlab('Rozmiar') +
  ylab('Waga')
```

```{r}
model_0.car.vol <- lm(carat ~ volume, diamonds)
summary(model_0.car.vol)
```

Wykres i parametry modelu potwierdzają ogromną zależność wagi od rozmiaru diamentu, gdyż $R^{2}$ wynosi aż 95,7%.

## Zależność ceny od wagi

```{r, message=F}
ggplot(diamonds, aes(carat, price)) +
  geom_point() +
  geom_smooth(method='lm') +
  labs(title='Wykres zależności ceny diamentu od jego wagi') +
  xlab('Waga') +
  ylab('Cena')
```

Na powyższym wykresie widoczna jest zależność ceny od wagi. Sprawdźmy to jeszcze za pomocą modelu liniowego:

```{r}
model_price_carat <- lm(price ~ carat, diamonds)
summary(model_price_carat)
```

Model jest istotny statystycznie, a do tego objaśnia znaczną część wariancji. Wiemy zatem, że cena jest liniowo zależna od wagi diamentu. Teraz zobaczmy, jak wykres zależności ceny od wagi prezentuje się z podziałem na kolor, jakość szlifu oraz poziom przejrzystości.

```{r}
plot_2_color <- ggplot(diamonds, aes(carat, price, color=color)) +
  labs(title='Cena diamentów w zależności od wagi', subtitle='Uwzględniony podział na kolor') +
  xlab('Waga') +
  ylab('Cena') +
  geom_point()
plot_2_cut <- ggplot(diamonds, aes(carat, price, color=cut)) +
  labs(subtitle='Uwzględniony podział na jakość szlifu') +
  xlab('Waga') +
  ylab('Cena') +
  geom_point()
plot_2_clarity <- ggplot(diamonds, aes(carat, price, color=clarity)) +
  labs(subtitle='Uwzględniony podział na poziom przejrzystości') +
  xlab('Waga') +
  ylab('Cena') +
  geom_point()

grid.arrange(plot_2_color, plot_2_cut, plot_2_clarity, nrow=3)

```

Widać dość wyraźny podział na klasy w zależności od przejrzystości oraz lekki podział ze względu na kolor. Zdaje się, że jakość szlifu nie powinna mieć wpływu na cenę.

## Cena diamentu a kolor, poziom przejrzystości i jakość szlifu

Sprawdzimy cenę poszczególnych dla poziomów przejrzystości:

```{r}
ggplot(diamonds, aes(clarity, price, fill=clarity)) +
  labs(title='Wykres pudełkowy ceny w zależności od przejrzystości') +
  xlab('Przejrzystość') +
  ylab('Cena') +
  geom_boxplot()
```

Jak widać, cena ma pewną zależność od przejrzystości. Problemem może być jednak waga samego diamentu (z wykresu możemy odczytać, że najmniej przejrzyste diamenty mają średnio wyższą cenę), która może być nieproporcjonalna dla różnych klas przejrzystości, a tym samym być główną przyczyną powyższego rozkładu. Zdefiniujemy zatem nową zmienną, która objaśniać będzie cenę diamentu przypadającą na jeden karat jego wagi.

```{r}
diamonds$price_carat <- diamonds$price / diamonds$carat
y_lab <- 'Cena za karat'

plot_3_color <- ggplot(diamonds, aes(carat, price_carat, color=color)) +
  labs(title='Cena diamentów w zależności od wagi', subtitle='Uwzględniony podział na kolor') +
  xlab('Waga') +
  ylab(y_lab) +
  geom_point() 

plot_3_cut <- ggplot(diamonds, aes(carat, price_carat, color=cut)) +
  labs(subtitle='Uwzględniony podział na jakość szlifu') +
  xlab('Waga') +
  ylab(y_lab) +
  geom_point() 

plot_3_clarity <- ggplot(diamonds, aes(carat, price_carat, color=clarity)) +
  labs(subtitle='Uwzględniony podział na poziom przejrzystości') +
  xlab('Waga') +
  ylab(y_lab) +
  geom_point()

grid.arrange(plot_3_color, plot_3_cut, plot_3_clarity, nrow=3)

```

```{r}
diamonds$price_carat <- diamonds$price / diamonds$carat
ggplot(diamonds, aes(clarity, price_carat, fill=clarity)) +
  labs(title='Wykres pudełkowy ceny za karat w zależności od przejrzystości') +
  xlab('Przejrzystość') +
  ylab('Dolar na karat') +
  geom_boxplot()
```

Cena na karat jednak nie różni się na tyle znacząco, by stwierdzić, iż zależy od przejrzystości. Widać jednak spadek ceny diamentów o najgorszej przejrzystości w porównaniu do poprzedniego wykresu pudełkowego, co wskazuje na ich większą wagę.

Sprawdźmy, jak wygląda sytuacja dla zmiennej \`color\`.

```{r}
boxplot_color_price <- ggplot(diamonds, aes(color, price, fill=color)) +
  labs(title='Wykres pudełkowy ceny w zależności od koloru') +
  xlab('Kolor') +
  ylab('Cena') +
  geom_boxplot()

boxplot_color_cprice <- ggplot(diamonds,aes(color, price_carat, fill=color)) +
  labs(title='Wykres pudełkowy ceny za karat w zależności od koloru') +
  xlab('Kolor') +
  ylab('Dolar za karat') +
  geom_boxplot()

grid.arrange(boxplot_color_price, boxplot_color_cprice, nrow=2)
```

Widać pewną zależność ceny od koloru, jednak brak jakiejkolwiek zależności dla ceny za karat od koloru. Ponownie, pewne diamenty zdają się mieć większą wagę, tym razem w zależności od koloru. Sprawdźmy jak wygląda cena przy poszczególnych jakościach szlifu.

```{r}
boxplot_cut_price <- ggplot(diamonds, aes(cut, price, fill=cut)) +
  labs(title='Wykres pudełkowy ceny w zależności od jakości szlifu') +
  xlab('Jakość szlifu') +
  ylab('Cena') +
  geom_boxplot()

boxplot_cut_cprice <- ggplot(diamonds, aes(cut, price_carat, fill=cut)) +
  labs(title='Wykres pudełkowy ceny za karat w zależności od jakości szlifu') +
  xlab('Jakość szlifu') +
  ylab('Dolar na karat') +
  geom_boxplot()

grid.arrange(boxplot_cut_price,boxplot_cut_cprice,nrow=2)
```

Widać lekkie odchylenie ceny w zależności od jakości szlifu, ale brak widocznej zależności dla ceny za karat.

## Waga diamentu a kolor, poziom przejrzystości i jakość szlifu

Powyższe rozważania sugerują nam, że kolor, poziom przejrzystości i jakość szlifu nie mają wpływu na cenę, ale na liniowo od niej zależną wagę diamentu.

```{r}
ggplot(diamonds, aes(color, carat, fill=color)) +
  labs(title='Wykres pudełkowy wagi diamentu w zależności od koloru') +
  xlab('Kolor') +
  ylab('Waga') +
  geom_boxplot()
```

```{r}
ggplot(diamonds, aes(clarity, carat, fill=clarity)) +
  labs(title='Wykres pudełkowy wagi diamentu w zależności od przejrzystości') +
  xlab('Przejrzystość') +
  ylab('Waga') +
  geom_boxplot()
```

Z powyższych wykresów można wywnioskować, że waga diamentów może mieć zależność od koloru i poziomu przejrzystości. Co ciekawe, to diamenty, których cechy (zmienne kategoryczne) oceniono "najgorzej", na wykresach występują jako najcięższe. To będzie pierwsza z naszych hipotez badawczych. Modele je weryfikujące zbudujemy w dalszej części pracy.

```{r}
ggplot(diamonds, aes(cut, carat, fill=cut)) +
  labs(title='Wykres pudełkowy wagi diamentu w zależności od jakości szlifu') +
  xlab('Jakość szlifu') +
  ylab('Waga') +
  geom_boxplot()
```

Z wykresu można odczytać, że waga nie zmienia się znacznie dla poszczególnych poziomów jakości szlifu. Widać pewną dysproporcję wagi jedynie dla diamentów o jakości szlifu "Ideal" oraz "Fair", jednak rozkład wagi diamentów ze szlifem o jakości "Premium", "Very good" oraz "Good" raczej przeczy, iż wraz z polepszeniem się szlifu waga maleje.

## Jakość szlifu a rozmiar diamentu

Dotychczas jakość szlifu nie wydawała się być istotną cechą wpływającą na cenę czy wagę diamentu. Zobaczmy, jak sprawa się ma w kontekście rozmiaru

```{r}
ggplot(diamonds, aes(cut, volume, fill=cut)) +
  labs(title='Wykres pudełkowy objętości w zależności od jakości szlifu ') +
  xlab('Jakość szlifu') +
  ylab('Objętość') +
  geom_boxplot()
```

Jedna obserwacja znacznie odstaje od reszty i utrudnia odczytywanie danych z wykresu. W naszych dalszych badaniach ją pominiemy.

```{r}
diamonds <- diamonds[-which(diamonds$volume==max(diamonds$volume)),]
```

Ponownie spójrzmy na ten wykres, teraz powinniśmy móc lepiej odczytać wyniki

```{r}
ggplot(diamonds, aes(cut, volume, fill=cut)) +
  labs(title='Wykres pudełkowy objętości w zależności od jakości szlifu ') +
  xlab('Jakość szlifu') +
  ylab('Objętość') +
  geom_boxplot()
```

Również rozmiar zdaje się nie wykazwyać liniowej zależności względem jakości szlifu. Ponownie, największa dysproporcja wyników jest między najlepszą a najgorszą jakością szlifu.

# Hipoteza 1: Im gorszy kolor i poziom przejrzystości diamentu, tym większa jego waga

```{r}
model_1_color <- aov(carat ~ color, diamonds)
print(summary.lm(model_1_color))

model_1_clarity <- aov(carat ~ clarity, diamonds)
print(summary.lm(model_1_clarity))

```

Modele zdają się wskazywać na pewne powiązanie wagi z kolorem oraz przejrzystością. Ponadto widzimy stopniowy wzrost współczynnika przy odpowiednio coraz gorszej przejrzystości. Sam kolor jest w stanie wyjaśnić \~ 9 % całkowitej wariancji, natomiast przejrzystość \~ 14 %. Sprawdźmy, jaki ułamek wariancji potrafi przewidzieć model uwzględniający obie zmienne:

```{r}
model_1_both <- aov(carat ~ color + clarity, diamonds)
print(summary.lm(model_1_both))
```

Model jest w stanie wyznaczyć \~23% wariancji

```{r}
ggplot(diamonds, aes(interaction(color, clarity), carat, fill=color)) +
  geom_boxplot(color = 'black') +
  xlab('Kombinacja Koloru i Klarowności') +
  ylab('Waga') +
  labs(title='Wykres pudełkowy z interakcjami dla wagi diamentu') +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  scale_fill_brewer(palette='Blues')
```

Jak widać na powyższym wykresie, zarówno kolor, jak i przejrzystość mają dość istotny wpływ na wagę. Co więcej, stopniowe pogarszanie klarowności wskazuje jednoznacznie na większą wagę, a pewne kolory diamentów wykazują większą wagę od pozostałych.

Hipotezę przyjmujemy za prawdziwą.

# Hipoteza 2: Jakość szlifu nie wpływa na rozmiar diamentów

```{r}
model_2_cut <- aov(volume ~ cut, diamonds)
print(summary.lm(model_2_cut))
```

Model wykazuje istotne różnice między poszczególnymi jakościami cięcia. Wartość $R^2$ jest natomiast bardzo mała - wynosi około 3%, co może sugerować, że inne zmienne wpływają na zmienną rozmiar diamentu.

Posortujmy szlif według współczynnika malejąco:

Fair

Premium

Good

Very Good

Ideal

Sprawdźmy, czy któraś zmienna wpływa na jakość szlifu, tzn. czy dana jakość szlifu jest powiązana z innymi zmiennymi, które w konsekwencji mogą mieć wpływ na rozmiar.

```{r}
ggplot(diamonds,aes(carat, cut, fill=cut)) +
  labs(title='Wykres pudełkowy wagi w zależności od jakości szlifu') +
  xlab('Waga') +
  ylab('Jakość szlifu') +
  geom_boxplot()

```

```{r}
model_2_carat_cut <- aov(carat ~ cut, diamonds)
print(summary.lm(model_2_carat_cut))
```

Mamy tę samą kolejność:

Fair

Premium

Good

Very good

Ideal

Waga wydaje się być skorelowana z jakością szlifu, sprawdźmy, czy jest skorelowana modelem ANOVA.

```{r}
carat_cut_ANOVA <- aov(carat ~ cut, diamonds)
summary.lm(carat_cut_ANOVA)
```

$R^2$ na poziomie \~0.035 wskazuje, że cięcie może nie być zbyt istotnym czynnikiem wpływającym na wagę diamentu.

Być może kolor jest powiązany z jakością cięcia. Sprawdźmy powiązanie zmiennych przez test Chi-kwadrat Pearsona.

```{r}
table(diamonds$cut, diamonds$color)
chisq.test(diamonds$cut, diamonds$color)
```

P-value \< 0.05. Jest pewne powiązanie, sprawdźmy więc model.

```{r}
color_volume_ANOVA <- aov(volume ~ color, diamonds)
summary.lm(color_volume_ANOVA)
```

Kolor wyjaśnia ponad trzykrotnie więcej wariancji, niż jakość szlifu.

```{r}
table(diamonds$cut, diamonds$color)
chisq.test(diamonds$cut, diamonds$color)

clarity_volume_ANOVA <- aov(volume ~ clarity, diamonds)
summary.lm(clarity_volume_ANOVA)
```

Jakość szlifu jest powiązana z przejrzystością. Przejrzystość wyjaśnia ponad 13% wariancji.

Sprawdźmy, czy dodając jakość szlifu do modelu istotnie zmieni się $R^2$:

```{r}
ANOVA_1 <- aov(volume ~ color + cut, diamonds)
ANOVA_2 <- aov(volume ~ clarity + cut, diamonds)
ANOVA_3 <- aov(volume ~ color + clarity, diamonds)
ANOVA_4 <- aov(volume ~ color + clarity + cut, diamonds)

summary.lm(ANOVA_1)
summary.lm(ANOVA_2)
summary.lm(ANOVA_3)
summary.lm(ANOVA_4)
```

Okazuje się, że model wykorzystując jedynie kolor oraz przejrzystość diamentu jest w stanie uzyskać $R^2$ na poziomie \~22.3%, dodanie jakości szlifu do modelu polepsza model o jedyne \~0.8 %, co wskazuje na dość istotny wpływ omówionych zmiennych na zmienną 'cut'.

Wniosek: Hipotezę przyjmujemy za prawdziwą.

# Hipoteza 3: Zmienna *table* wpływa na *depth*

Bardzo duży wpływ na wygląd diamentu mają proporcje wielkości opisanych w naszych danych zmiennymi `table` oraz `depth`. Sprawdzimy, czy jedna wpływa na drugą.

```{r}
ggplot(diamonds, aes(table, depth)) +
  labs(title='Zależność zmiennej depth od table') +
  geom_point()

model_3 <- lm(depth ~ table, diamonds)
summary.lm(model_3)
```

Dla takiego modelu zachodzi istotność statystyczna, jednakże $R^2$ wynosi zaledwie niecałe 9%. Spróbujmy znaleźć zmienną towarzyszącą, która mogłaby ten parametr poprawić.

```{r}
plot_4_color <- ggplot(diamonds, aes(table, depth, color=color)) +
  labs(title='Zależność zmiennej depth od table', subtitle='Uwzględniony podział na kolor') +
  geom_point()

plot_4_cut <- ggplot(diamonds, aes(table, depth, color=cut)) +
  labs(subtitle='Uwzględniony podział na jakość szlifu') +
  geom_point()

plot_4_clarity <- ggplot(diamonds, aes(table, depth, color=clarity)) +
  labs(subtitle='Uwzględniony podział na poziom przejrzystości') +
  geom_point()

grid.arrange(plot_4_color, plot_4_cut, plot_4_clarity, nrow=3)
```

Zmienna jakości szlifu zdaje się układać na wykresie znacznie mniej chaotycznie od pozostałych. Przyjrzyjmy się jej na wykresie z liniami regresji dla poszczególnych poziomów jakości szlifu.

```{r}
ggplot(diamonds, aes(table, depth, color=cut)) +
  geom_point() +
  geom_smooth(method='lm', formula='y~x')
```

Spróbujmy zbudować model z uwzględnieniem zmiennej `cut`.

```{r}
model_3_cut <- lm(depth ~ table + cut, diamonds)
summary.lm(model_3_cut)
```

Zmienna `cut` pozwala na objaśnienie \~26% wariancji. Sprawdźmy, czy zaimplementowanie interakcji będzie zasadne.

```{r}
model_3_cut2 <- lm(depth ~ table * cut, diamonds)
summary.lm(model_3_cut2)
```

Model z interakcją radzi sobie nieco lepiej. Interakcje między `table` a każdą przyjmowaną przez `cut` wartością są istotne statystycznie.

Sprawdźmy jeszcze, czy aby na pewno użycie zmiennych towarzyszących `clarity` i `color` nie da lepszego efektu.

```{r}
model_3_color <- lm(depth ~ table + color, diamonds)
summary.lm(model_3_color)

model_3_clarity <- lm(depth ~ table + clarity, diamonds)
summary.lm(model_3_clarity)
```

Modele nie radzą sobie tak dobrze, jak ten ze zmienną `cut`. Zatem szerokość górnej części diamentu wpływa na proporcję wysokości diamentu do jego obwodu, jednak dobrze jest uwzględnić zmienną towarzyszącą jakości szlifu, co pozwala na lepsze objaśnianie wariancji zmiennej celu.
